<html>
    <head>
        <!-- Load Plotly JS from CDN -->
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
        <style>
            .loading {
                display: inline-block;
                padding: 10px 20px;
                background-color: #f0f0f0;
                border-radius: 4px;
                margin: 10px 0;
            }
            .error {
                color: #d32f2f;
                padding: 10px;
                background-color: #ffebee;
                border-left: 4px solid #d32f2f;
                margin: 10px 0;
            }
            .visualization-container {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: flex-start;
            }
            .plot-area {
                flex: 1;
                min-width: 600px;
            }
            .info-panel {
                width: 300px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                position: sticky;
                top: 20px;
                min-height: 300px;
            }
            .info-placeholder {
                color: #666;
                text-align: center;
                padding-top: 100px;
                font-style: italic;
            }
            .molecule-detail {
                display: none;
            }
            .molecule-detail img {
                width: 100%;
                height: auto;
                border: 1px solid #eee;
                background: white;
                border-radius: 4px;
                margin: 10px 0;
            }
            .molecule-detail .name {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 10px;
                color: #2196F3;
                word-break: break-word;
            }
            .molecule-detail .property {
                margin-bottom: 8px;
                font-size: 13px;
            }
            .molecule-detail .label {
                font-weight: bold;
                color: #555;
            }
            .molecule-detail .smiles {
                font-family: monospace;
                font-size: 11px;
                background: white;
                padding: 5px;
                border: 1px solid #eee;
                border-radius: 4px;
                word-break: break-all;
                max-height: 100px;
                overflow-y: auto;
            }
        </style>
    </head>
    <body>
        <h1>Analysis Results</h1>

        <h3>PDB Information</h3>
        <div style="background-color: #e8f4f8; padding: 1em; margin: 1em 0; border-left: 4px solid #2196F3;">
            <strong>Target selected:</strong> {{ target }}<br>
            <strong>PDB ID:</strong> {{ pdb_id }}<br>
            <strong>Title:</strong> {{ pdb_title }}
        </div>

        {% if target == "TPP" %}
        <img src="{{ url_for('static', filename='pdb_2gdi.png') }}" alt="PDB 2GDI Structure" style="max-width: 400px; margin: 20px 0;">
        {% endif %}
        
        <div style="background-color: lightgray; padding: 1em; margin: 1em 0;">
            {{ analysis|safe }}
        </div>
        
        
        <h3>Example Active Hits (up to 10)</h3>
        <div style="background-color: #f0f0f0; padding: 1em; margin: 1em 0; font-family: monospace;">
            {{ examples|safe }}
        </div>
        
        <h3>Chemical Space Visualization (UMAP)</h3>
        <p style="color: #666; font-size: 14px; margin: 10px 0;">
            <strong>âœ¨ Interactive Features:</strong> Hover over any point to see the molecule information in the panel to the right. Click and drag to pan, scroll to zoom.
        </p>
        
        <div id="loading" class="loading">Loading UMAP visualization with molecule structures... This may take a few moments.</div>
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div class="visualization-container">
            <div class="plot-area">
                <div id="umap-plot" style="width: 100%; height: 600px;"></div>
            </div>
            <div class="info-panel">
                <div id="info-placeholder" class="info-placeholder">
                    Hover over a point on the plot<br>to see molecule details
                </div>
                <div id="molecule-detail" class="molecule-detail">
                    <div id="mol-name" class="name"></div>
                    <img id="mol-img" src="" alt="Molecule Structure">
                    <div class="property">
                        <span class="label">Coordinates:</span><br>
                        UMAP-1: <span id="mol-x"></span><br>
                        UMAP-2: <span id="mol-y"></span>
                    </div>
                    <div class="property">
                        <span class="label">SMILES:</span>
                        <div id="mol-smiles" class="smiles"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            let moleculeData = null;
            const detailPanel = document.getElementById('molecule-detail');
            const placeholder = document.getElementById('info-placeholder');
            
            // UI Elements
            const molName = document.getElementById('mol-name');
            const molImg = document.getElementById('mol-img');
            const molX = document.getElementById('mol-x');
            const molY = document.getElementById('mol-y');
            const molSmiles = document.getElementById('mol-smiles');
            
            // Fetch UMAP plot components (Plotly)
            fetch('/umap_plot', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'target={{ target }}'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to generate UMAP');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loading message
                document.getElementById('loading').style.display = 'none';
                
                // Store molecule data
                moleculeData = {
                    images: data.images,
                    names: data.names,
                    smiles: data.smiles,
                    // Extract coordinates from plot data for easy access
                    x: data.plot_data.data[0].x,
                    y: data.plot_data.data[0].y
                };
                
                // Create the Plotly plot using the JSON data
                const plotDiv = document.getElementById('umap-plot');
                
                // Adjust layout for embedded view
                const layout = data.plot_data.layout;
                layout.width = null; // Let it be responsive
                layout.height = 600;
                layout.margin = {l: 50, r: 20, t: 50, b: 50};
                
                Plotly.newPlot('umap-plot', data.plot_data.data, layout, {
                    displayModeBar: true, 
                    displaylogo: false,
                    responsive: true
                });
                
                // Add event listener for hover to show molecule structure
                plotDiv.on('plotly_hover', function(eventData) {
                    const pointIndex = eventData.points[0].pointIndex;
                    
                    // Update details
                    molName.textContent = moleculeData.names[pointIndex];
                    molImg.src = moleculeData.images[pointIndex];
                    molX.textContent = moleculeData.x[pointIndex].toFixed(2);
                    molY.textContent = moleculeData.y[pointIndex].toFixed(2);
                    molSmiles.textContent = moleculeData.smiles[pointIndex];
                    
                    // Show details, hide placeholder
                    placeholder.style.display = 'none';
                    detailPanel.style.display = 'block';
                });
                
                // Optional: Clear on unhover, or keep last selected
                // plotDiv.on('plotly_unhover', function() {
                //    placeholder.style.display = 'block';
                //    detailPanel.style.display = 'none';
                // });
            })
            .catch(error => {
                // Hide loading message and show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Error: ' + error.message;
                console.error('UMAP Error:', error);
            });
        </script>
        
        <br>
        <a href="/">Analyze another target</a>
    </body>
</html>