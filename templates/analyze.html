<html>
    <head>
        <!-- Load Plotly JS from CDN -->
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
        <!-- Load 3Dmol.js from CDN -->
        <script src="https://3Dmol.csb.pitt.edu/build/3Dmol-min.js"></script>
        <style>
            .loading {
                display: inline-block;
                padding: 10px 20px;
                background-color: #f0f0f0;
                border-radius: 4px;
                margin: 10px 0;
            }
            .error {
                color: #d32f2f;
                padding: 10px;
                background-color: #ffebee;
                border-left: 4px solid #d32f2f;
                margin: 10px 0;
            }
            .visualization-container {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                align-items: flex-start;
            }
            .plot-area {
                flex: 1;
                min-width: 600px;
                /* width: 600px; */
            }
            .info-panel {
                width: 420px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 15px;
                position: sticky;
                top: 20px;
                min-height: 300px;
            }
            .info-placeholder {
                color: #666;
                text-align: center;
                padding-top: 100px;
                font-style: italic;
            }
            .molecule-detail {
                display: none;
            }
            .molecule-detail img {
                width: 100%;
                height: auto;
                border: 1px solid #eee;
                background: white;
                border-radius: 4px;
                margin: 10px 0;
            }
            .molecule-detail .name {
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 10px;
                color: #2196F3;
                word-break: break-word;
            }
            .molecule-detail .property {
                margin-bottom: 8px;
                font-size: 13px;
            }
            .molecule-detail .label {
                font-weight: bold;
                color: #555;
            }
            .molecule-detail .smiles {
                font-family: monospace;
                font-size: 11px;
                background: white;
                padding: 5px;
                border: 1px solid #eee;
                border-radius: 4px;
                word-break: break-all;
                max-height: 100px;
                overflow-y: auto;
            }
            .action-container {
                text-align: center;
                margin: 40px 0;
            }
            .action-button {
                display: inline-block;
                padding: 15px 30px;
                font-size: 18px;
                font-weight: bold;
                color: white;
                background-color: #2196F3;
                text-decoration: none;
                border-radius: 5px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
                transition: background-color 0.3s;
            }
            .action-button:hover {
                background-color: #1976D2;
            }
            #pdb-viewer-container {
                display: flex;
                justify-content: center;
                margin: 30px 0;
            }
            #pdb-viewer {
                width: 700px;
                height: 500px;
                position: relative;
                border: 2px solid #2196F3;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            }
        </style>
    </head>
    <body>
        <h1>Analysis Results</h1>

        <h2>RNA Target Information</h2>
        <div id="pdb-viewer-container">
            <div id="pdb-viewer"></div>
        </div>
        
        <div style="background-color: #e8f4f8; padding: 1em; margin: 1em 0; border-left: 4px solid #2196F3; max-width: 700px; margin-left: auto; margin-right: auto;">
            <strong>RNA Target:</strong> {{ target }}<br>
            <strong>PDB ID:</strong> {{ pdb_id }}<br>
            <strong>PDB Title:</strong> {{ pdb_title }}
        </div>
        
        {% if analysis %}
        <div style="background-color: lightgray; padding: 1em; margin: 1em 0;">
            {{ analysis|safe }}
        </div>
        {% endif %}
        
        <h2>Evaluate RNAmigo2</h2>
        <p>A structure-based deep learning virtual screening pipeline for RNA targets</p>
        
        <h2>Analyze Active Hits</h2>
        <p>Number of active molecules: {{ num_hits }}</p>
        <div style="background-color: #f0f0f0; padding: 1em; margin: 1em 0; font-family: monospace; max-height: 300px; overflow-y: auto; border: 1px solid #ccc;">
            {{ examples|safe }}
        </div>
        
        
        <h3>Chemical Space Visualization (UMAP)</h3>
        <p style="color: #666; font-size: 14px; margin: 10px 0;">
            <strong>âœ¨ Interactive Features:</strong> Hover over any point to see the molecule information in the panel to the right. Click and drag to pan, scroll to zoom.
        </p>
        
        <div id="loading" class="loading">Loading UMAP visualization with molecule structures... This may take a few moments.</div>
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div class="visualization-container">
            <div class="plot-area">
                <div id="umap-plot" style="width: 100%; height: 600px;"></div>
            </div>
            <div class="info-panel">
                <div id="info-placeholder" class="info-placeholder">
                    Hover over a point on the plot<br>to see molecule details
                </div>
                <div id="molecule-detail" class="molecule-detail">
                    <div id="mol-name" class="name"></div>
                    <img id="mol-img" src="" alt="Molecule Structure">
                    <div class="property">
                        <span class="label">Coordinates:</span><br>
                        UMAP-1: <span id="mol-x"></span><br>
                        UMAP-2: <span id="mol-y"></span>
                    </div>
                    <div class="property">
                        <span class="label">SMILES:</span>
                        <div id="mol-smiles" class="smiles"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <script>
            let moleculeData = null;
            const detailPanel = document.getElementById('molecule-detail');
            const placeholder = document.getElementById('info-placeholder');
            
            // UI Elements
            const molName = document.getElementById('mol-name');
            const molImg = document.getElementById('mol-img');
            const molX = document.getElementById('mol-x');
            const molY = document.getElementById('mol-y');
            const molSmiles = document.getElementById('mol-smiles');
            
            // Fetch UMAP plot components (Plotly)
            fetch('/umap_plot', {
                method: 'POST',
                headers: {'Content-Type': 'application/x-www-form-urlencoded'},
                body: 'target={{ target }}'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Failed to generate UMAP');
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide loading message
                document.getElementById('loading').style.display = 'none';
                
                // Store molecule data
                moleculeData = {
                    images: data.images,
                    names: data.names,
                    smiles: data.smiles,
                    // Extract coordinates from plot data for easy access
                    x: data.plot_data.data[0].x,
                    y: data.plot_data.data[0].y
                };
                
                // Create the Plotly plot using the JSON data
                const plotDiv = document.getElementById('umap-plot');
                
                // Adjust layout for embedded view
                const layout = data.plot_data.layout;
                layout.width = null; // Let it be responsive
                layout.height = 600;
                layout.margin = {l: 50, r: 20, t: 50, b: 50};
                
                Plotly.newPlot('umap-plot', data.plot_data.data, layout, {
                    displayModeBar: true, 
                    displaylogo: false,
                    responsive: true
                });
                
                // Add event listener for hover to show molecule structure
                plotDiv.on('plotly_hover', function(eventData) {
                    const pointIndex = eventData.points[0].pointIndex;
                    
                    // Update details
                    molName.textContent = moleculeData.names[pointIndex];
                    molImg.src = moleculeData.images[pointIndex];
                    molX.textContent = moleculeData.x[pointIndex].toFixed(2);
                    molY.textContent = moleculeData.y[pointIndex].toFixed(2);
                    molSmiles.textContent = moleculeData.smiles[pointIndex];
                    
                    // Show details, hide placeholder
                    placeholder.style.display = 'none';
                    detailPanel.style.display = 'block';
                });
                
                // Optional: Clear on unhover, or keep last selected
                // plotDiv.on('plotly_unhover', function() {
                //    placeholder.style.display = 'block';
                //    detailPanel.style.display = 'none';
                // });
            })
            .catch(error => {
                // Hide loading message and show error
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = 'Error: ' + error.message;
                console.error('UMAP Error:', error);
            });
        </script>
        
        <script>
            // Initialize 3Dmol.js viewer for PDB structure
            let pdbViewer;
            
            function initPDBViewer() {
                pdbViewer = $3Dmol.createViewer("pdb-viewer", {
                    backgroundColor: "white",
                    ui: true  // Enable UI controls
                });
            }
            
            function loadPDBStructure() {
                const pdbId = "{{ pdb_id }}";
                
                if (!pdbId) return;
                
                // Clear previous structure
                pdbViewer.clear();
                
                // Load from RCSB by PDB ID
                $3Dmol.download(`pdb:${pdbId}`, pdbViewer, {}, function () {
                    // Add a cartoon representation with spectrum coloring
                    pdbViewer.setStyle({}, { cartoon: { color: "spectrum" } });
                    
                    // Zoom to fit the structure
                    pdbViewer.zoomTo();
                    
                    // Enable spinning animation around y-axis at speed 2
                    pdbViewer.spin('y', 2);
                    
                    pdbViewer.render();
                });
            }
            
            // Initialize and load PDB structure when page loads
            window.addEventListener('DOMContentLoaded', function() {
                initPDBViewer();
                loadPDBStructure();
            });
        </script>
        
        <div class="action-container">
            <a href="/" class="action-button">Analyze another target</a>
        </div>
    </body>
</html>